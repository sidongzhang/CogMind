# Day 1 Progress - æ³¨æ„åŠ›æœºåˆ¶å®ç°
## ğŸ¯ ä»Šæ—¥æˆå°±
- âœ… å®ç°äº†ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ (ScaledDotProductAttention)
- âœ… æ”¯æŒå› æœæ©ç å’Œå¡«å……æ©ç 
- âœ… ç¼–å†™äº†å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹
- âœ… ç†è§£å¹¶å®ç°å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ŒæŒæ¡åˆ†å¤´è®¡ç®—ä¸åˆå¹¶çš„åŸç†

## ğŸ“š å­¦ä¹ è¦ç‚¹
1. **d_k çš„ä½œç”¨**ï¼šæŸ¥è¯¢å’Œé”®å‘é‡çš„ç»´åº¦ï¼Œç”¨äºç¼©æ”¾è®¡ç®—
2. **QKV ç†è§£**ï¼šQuery-Key-Value åˆ†åˆ«ä»£è¡¨æŸ¥è¯¢ã€é”®å’Œå€¼
3. **æ©ç æœºåˆ¶**ï¼šé€šè¿‡è®¾ç½® -inf æ¥å±è”½ç‰¹å®šä½ç½®çš„æ³¨æ„åŠ›


# ä»Šæ—¥ç–‘é—®
## 1.d_kæ˜¯ä»€ä¹ˆ
ç­”ï¼šd_k æ˜¯é”®å‘é‡å’ŒæŸ¥è¯¢å‘é‡çš„ç»´åº¦ã€‚
 - Q (Query)ï¼šæŸ¥è¯¢å‘é‡ï¼Œè¡¨ç¤º"æˆ‘åœ¨æ‰¾ä»€ä¹ˆ"
 - K (Key)ï¼šé”®å‘é‡ï¼Œè¡¨ç¤º"æˆ‘æœ‰ä»€ä¹ˆä¿¡æ¯"ï¼ˆå¯ä»¥æä¾›çš„ç‰¹å¾ï¼‰
 - V (Value)ï¼šå€¼å‘é‡ï¼Œè¡¨ç¤º"æˆ‘çš„å®é™…å†…å®¹æ˜¯ä»€ä¹ˆ"ï¼ˆå…·æœ‰çš„ä¿¡æ¯ï¼‰
### ï¼ˆé¢å¤–é—®é¢˜ï¼‰ä¸ºä»€ä¹ˆéœ€è¦ d_kï¼Ÿï¼ˆç®€è¿°ï¼‰
    ç¼©æ”¾å› å­ 1/sqrt(d_k)
    ä¸ºäº†é˜²æ­¢ç‚¹ç§¯ç»“æœè¿‡å¤§ï¼Œå¯¼è‡´ softmax æ¢¯åº¦æ¶ˆå¤±ã€‚

## 2.Q,K,Vçš„ç»´åº¦ä¸å¤ªç†è§£
 [batch_size, seq_len, d_k] çš„å«ä¹‰ï¼š
 - batch_size: åŒæ—¶å¤„ç†å¤šå°‘ä¸ªæ ·æœ¬ï¼ˆå¦‚2ä¸ªå¥å­ï¼‰
 - seq_len: åºåˆ—é•¿åº¦ï¼ˆå¦‚æ¯ä¸ªå¥å­4ä¸ªè¯ï¼‰
 - d_k: æ¯ä¸ªè¯çš„å‘é‡ç»´åº¦ï¼ˆå¦‚8ç»´ï¼‰

## 3.ä¸ºå•¥ä¼šæœ‰ä¸¤æ¬¡æ©ç 
 - ç¬¬ä¸€æ¬¡æ©ç  - å› æœæ©ç  (Causal Mask)ï¼š
     - ç”¨é€”ï¼šç¡®ä¿åœ¨ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œæ¯ä¸ªè¯åªèƒ½çœ‹åˆ°å®ƒä¹‹å‰çš„è¯ï¼Œä¸èƒ½"å·çœ‹"æœªæ¥çš„è¯
     - åœºæ™¯ï¼šä¸»è¦ç”¨äºè§£ç å™¨ï¼Œä¿è¯è‡ªå›å½’ç”Ÿæˆ
 - ç¬¬äºŒæ¬¡æ©ç  - å¡«å……æ©ç  (Padding Mask)ï¼š
     - ç”¨é€”ï¼šå¿½ç•¥å¡«å……ç¬¦å·ï¼ˆpadding tokensï¼‰ï¼Œä¸è®©æ¨¡å‹å…³æ³¨æ— æ„ä¹‰çš„å¡«å……ä½ç½®
     - åœºæ™¯ï¼šå¤„ç†å˜é•¿åºåˆ—æ—¶ä½¿ç”¨

## 4.æ©ç é‚£é‡Œå…·ä½“æ€ä¹ˆå®ç°çš„ï¼Œä¸ºä»€ä¹ˆè¿™æ ·å†™å¯ä»¥å®ç°
æ©ç çš„æ ¸å¿ƒæ€æƒ³ï¼šåœ¨ softmax ä¹‹å‰ï¼ŒæŠŠè¦å±è”½çš„ä½ç½®è®¾ä¸ºè´Ÿæ— ç©·
// ...existing code...
```python
if self.causal:
    seq_len = scores.size(-1)
    causal_mask = torch.triu(
        torch.ones((seq_len, seq_len), device=scores.device),
        diagonal=1
    ).bool()
    scores.masked_fill_(causal_mask, float('-inf'))
```
// ...existing code...
### eg æ­¥éª¤åˆ†è§£ï¼š
#### 1. åˆ›å»ºæ©ç çŸ©é˜µ:
    è¦å±è”½çš„ä½ç½®ä¸º1ï¼Œå…¶ä»–ä¸º0
#### 2. ä½¿ç”¨masked_fill:
    æŠŠæ©ç ä¸º1çš„ä½ç½®æ›¿æ¢ä¸º -inf
#### 3. softmax è®¡ç®—ï¼š
    e^(-inf) = 0ï¼Œæ‰€ä»¥è¿™äº›ä½ç½®çš„æƒé‡ä¸º0
### eg:
    scores = [ [1.2, 0.8, 0.5],   # åŸå§‹å¾—åˆ†
           [0.9, 1.1, 0.7],
           [0.6, 0.4, 1.0] ]

    mask = [ [0, 0, 1],           # è¦å±è”½ç¬¬ä¸‰ä¸ªä½ç½®
         [0, 0, 1], 
         [0, 0, 1] ]

#### åº”ç”¨æ©ç åï¼š
    scores = [ [1.2, 0.8, -inf],  # ç¬¬ä¸‰ä¸ªä½ç½®è¢«å±è”½
           [0.9, 1.1, -inf],
           [0.6, 0.4, -inf] ]

#### softmax å:
    -inf çš„ä½ç½®æƒé‡ä¸º0
## 5.ä¸ºä»€ä¹ˆåœ¨viewä¸­ä½¿ç”¨ -1
```
K = self.W_k(K).view(batch_size, -1, self.num_heads, self.d_k).transpose(1, 2)
```
-1 æ˜¯ PyTorch ä¸­çš„ä¸€ä¸ªç‰¹æ®Šç¬¦å·ï¼Œè¡¨ç¤º "**è‡ªåŠ¨è®¡ç®—è¿™ä¸ªç»´åº¦çš„å¤§å°**"

#### ä¸ºä»€ä¹ˆç”¨-1ï¼Ÿ
    è®©ä»£ç æ›´çµæ´»ï¼Œå¦‚æœåºåˆ—é•¿åº¦å˜åŒ–ä¹Ÿèƒ½è‡ªåŠ¨é€‚åº”
    é¿å…ç¡¬ç¼–ç ï¼Œå‡å°‘å‡ºé”™å¯èƒ½

### 6.å¦‚ä½•ä½“ç°æ¯ä¸ªå¤´ç‹¬ç«‹è®¡ç®—ï¼Ÿ
```
# å˜æ¢å‰ï¼šæ‰€æœ‰å¤´æ··åœ¨ä¸€èµ·
Q = [batch_size, seq_len, d_model]  # å¦‚ [2, 4, 8]

# åˆ†å¤´å˜æ¢åï¼šæ¯ä¸ªå¤´ç‹¬ç«‹
Q = Q.view(batch_size, seq_len, num_heads, d_k).transpose(1, 2)
# å½¢çŠ¶å˜ä¸ºï¼š[batch_size, num_heads, seq_len, d_k] å¦‚ [2, 2, 4, 4]

# ç°åœ¨å¼ é‡ç»“æ„ï¼š
# ç¬¬0ä¸ªå¤´ï¼šQ[0, 0, :, :] -> [4, 4]  # ç¬¬ä¸€ä¸ªbatchï¼Œç¬¬ä¸€ä¸ªå¤´
# ç¬¬1ä¸ªå¤´ï¼šQ[0, 1, :, :] -> [4, 4]  # ç¬¬ä¸€ä¸ªbatchï¼Œç¬¬äºŒä¸ªå¤´
```
å®é™…è®¡ç®—æ—¶ï¼š
```
# self.attention å†…éƒ¨å¤„ç†çš„æ˜¯4Då¼ é‡
# ä½†å®ƒä¼šåœ¨ batch_size * num_heads è¿™ä¸ªç»´åº¦ä¸Šå¹¶è¡Œè®¡ç®—
# ç›¸å½“äºåŒæ—¶è®¡ç®— 2(batch) * 2(heads) = 4 ä¸ªç‹¬ç«‹çš„æ³¨æ„åŠ›æœºåˆ¶

```
### 7.å¦‚ä½•åˆå¹¶å¤šä¸ªå¤´çš„è¾“å‡ºï¼Ÿ
è¿™æ˜¯åˆ†å¤´æ“ä½œçš„é€†è¿‡ç¨‹ï¼š
```
# æ³¨æ„åŠ›è®¡ç®—åçš„è¾“å‡ºå½¢çŠ¶ï¼š[batch_size, num_heads, seq_len, d_k]
output = [2, 2, 4, 4]  # 2ä¸ªbatchï¼Œ2ä¸ªå¤´ï¼Œåºåˆ—é•¿4ï¼Œæ¯ä¸ªå¤´ç»´åº¦4

# æ­¥éª¤1ï¼šè½¬ç½®ï¼ŒæŠŠnum_headsç»´åº¦ç§»åˆ°åé¢
output = output.transpose(1, 2)  # [2, 4, 2, 4]
# ç°åœ¨å½¢çŠ¶ï¼šbatch_size, seq_len, num_heads, d_k

# æ­¥éª¤2ï¼šåˆå¹¶æœ€åä¸¤ä¸ªç»´åº¦
output = output.contiguous().view(batch_size, seq_len, d_model)  # [2, 4, 8]
# æŠŠ [2, 4] åˆå¹¶æˆ [8]ï¼Œå› ä¸º 2 heads * 4 d_k = 8 d_model
```
